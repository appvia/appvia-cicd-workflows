---
name: Update Pull Request
description: "Updates the pull request with the latest Terragrunt plan"
inputs:
  status-format:
    description: "The format of the status comment"
    required: true

  status-hcl-format:
    description: "The HCL format of the status comment"
    required: true

  status-inputs-render:
    description: "The inputs render of the status comment"
    required: true

  status-inputs-diff:
    description: "The inputs diff of the status comment"
    required: true

  status-linting:
    description: "The linting of the status comment"
    required: true

  status-security:
    description: "The security of the status comment"
    required: true

  status-auth:
    description: "The authentication of the status comment"
    required: true

  status-plan:
    description: "The plan of the status comment"
    required: true

  status-commitlint:
    description: "The commitlint of the status comment"
    required: true

outputs:
  result:
    description: "The result of the update"
    value: ${{ steps.update.outputs.result }}

runs:
  using: "composite"
  steps:
    - name: Add PR Comment
      id: update
      uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
      with:
        script: |
          // 1. Retrieve existing bot comments for the PR
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          })
          const botComment = comments.find(comment => {
            return comment.user.type === 'Bot' && comment.body.includes('Pull Request Review Status (${{ inputs.environment }})')
          })

          // 2. Prepare format of the comment
          const output = `### Pull Request Review Status (${{ inputs.environment }})
          * ğŸ–Œ <b>Terragrunt Format and Style:</b>      \`${{ inputs.status-format }}\`
          * ğŸ–Œ <b>Terragrunt HCL Format and Style:</b>  \`${{ inputs.status-hcl-format }}\`
          * ğŸ” <b>Terragrunt Inputs Render:</b>         \`${{ inputs.status-inputs-render }}\`
          * ğŸ” <b>Terragrunt Inputs Diff:</b>           \`${{ inputs.status-inputs-diff }}\`
          * ğŸ” <b>Terragrunt Linting:</b>               \`${{ inputs.status-linting }}\`
          * ğŸ” <b>Terragrunt Security:</b>              \`${{ inputs.status-security }}\`
          * ğŸ”‘ <b>AWS Authentication:</b>               \`${{ inputs.status-auth }}\`
          * ğŸ“– <b>Terragrunt Plan:</b>                  \`${{ inputs.status-plan }}\`
          * ğŸ”– <b>Commitlint:</b>                       \`${{ inputs.status-commitlint }}\`

          *<b>Pusher:</b> @${{ github.actor }}, <b>Action:</b> \`${{ github.event_name }}\`*
          *<b>Workflow Run Link:</b> ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*`;

          // 4. If we have a comment, update it, otherwise create a new one
          if (botComment) {
            github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
            })
          } else {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
          }
