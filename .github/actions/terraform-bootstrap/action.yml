---
name: Terraform Bootstrap
description: "Terraform bootstrapping including AWS auth, init with S3 backend"
inputs:
  actions-id:
    description: "The application ID for the workflow token"
    required: false
  actions-secret:
    description: "The application secret for the workflow token"
    required: false
  aws-account-id:
    description: "The AWS account ID to deploy to"
    required: true
  aws-read-role-name:
    description: "Overrides the default behavior, and uses a custom role name for read-only access"
    required: false
  aws-role:
    description: "The role to assume"
    required: true
  aws-web-identity-token-file:
    description: "The file to store the web identity token in"
    required: true
  aws-write-role-name:
    description: "Overrides the default behavior, and uses a custom role name for read-write access"
    required: false
  aws-region:
    description: "The AWS region to deploy to"
    required: true
  enable-private-access:
    description: Optional flag to state if terraform requires pulling private modules
    required: true
  environment:
    description: "The environment to deploy to"
    required: false
  organization-name:
    description: "The name of the Github organization"
    required: false
  terraform-dir:
    description: "The directory to validate"
    required: true
  terraform-init-extra-args:
    description: "Extra arguments to pass to terraform init"
    required: false
  terraform-state-key:
    description: "The key of the terraform state (default: <repo-name>.tfstate)"
    required: false
  terraform-version:
    description: "The version of terraform to use"
    required: true
  use-env-as-suffix:
    description: "Whether to use the environment as a suffix for the state file and iam roles"
    required: false
  working-directory:
    description: "The working directory to run the action in"
    required: true
outputs:
  outcome-auth:
    description: "Outcome of the auth step"
    value: ${{ steps.auth.outcome }}
  outcome-init:
    description: "Outcome of the init step"
    value: ${{ steps.init.outcome }}

runs:
  using: "composite"
  steps:
    - name: Setup node
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
      with:
        node-version: 16

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
      with:
        terraform_version: ${{ inputs.terraform-version }}

    - name: Retrieve Web Identity Token for AWS Authentication
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com" | jq -r '.value' > "${{ inputs.aws-web-identity-token-file }}"

    - name: Determine AWS Role
      id: role
      shell: bash
      run: |
        role_suffix=""
        aws_read_role_name="${{ inputs.aws-read-role-name }}"
        aws_write_role_name="${{ inputs.aws-write-role-name }}"
        if [ "${{ inputs.use-env-as-suffix }}" == "true" ]; then
          role_suffix="-${{ inputs.environment }}"
        fi
        if [[ "${GITHUB_REF##*/}" == "main" ]]; then
          echo "name=${aws_write_role_name:-${{ inputs.aws-role }}${role_suffix}}" >> "${GITHUB_OUTPUT}"
        else
          echo "name=${aws_read_role_name:-${{ inputs.aws-role }}${role_suffix}-ro}" >> "${GITHUB_OUTPUT}"
        fi

    - name: Authenticate with AWS
      id: auth
      uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7 # v6
      with:
        aws-region: ${{ inputs.aws-region }}
        mask-aws-account-id: "true"
        role-session-name: ${{ github.event.repository.name }}
        role-to-assume: arn:aws:iam::${{ inputs.aws-account-id }}:role/${{ steps.role.outputs.name }}

    - name: Set terraform-state-key variable
      id: state-key
      shell: bash
      run: |
        if [ -n "${{ inputs.terraform-state-key }}" ]; then
          echo "name=${{ inputs.terraform-state-key }}" >> "${GITHUB_OUTPUT}"
        else
          if [ "${{ inputs.use-env-as-suffix }}" == "true" ]; then
            echo "name=${{ github.event.repository.name }}-${{ inputs.environment }}.tfstate" >> "${GITHUB_OUTPUT}"
          else
            echo "name=${{ github.event.repository.name }}.tfstate" >> "${GITHUB_OUTPUT}"
          fi
        fi

    - name: Enable Private Modules
      id: get_workflow_token
      if: ${{ inputs.enable-private-access == 'true' }}
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
      with:
        app-id: ${{ inputs.actions-id }}
        private-key: ${{ inputs.actions-secret }}
        owner: ${{ inputs.organization-name }}

    - name: Setup Credentials
      if: ${{ inputs.enable-private-access == 'true' }}
      shell: bash
      run: |
        git config --global url."https://x-access-token:${{steps.get_workflow_token.outputs.token}}@github.com/".insteadOf "https://github.com/"
        
    - name: Terraform init
      id: init
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        terraform -chdir=${{ inputs.terraform-dir }} init \
          -backend-config="bucket=${{ inputs.aws-account-id }}-${{ inputs.aws-region }}-tfstate" \
          -backend-config="key=${{ steps.state-key.outputs.name }}" \
          -backend-config="encrypt=true" \
          -backend-config="use_lockfile=true" \
          -backend-config="region=${{ inputs.aws-region }}" ${{ inputs.terraform-init-extra-args }}
